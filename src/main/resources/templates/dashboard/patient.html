<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Mon Tableau de Bord - Patient</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card {
            transition: transform 0.2s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .stat-card {
            background: linear-gradient(135deg, #198754, #20c997);
            color: white;
        }
        .rdv-annule {
            opacity: 0.6;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Navigation -->
        <nav class="navbar navbar-light bg-light mb-4">
            <div class="navbar-nav">
                <a class="nav-link" th:href="@{/}">üè† Accueil</a>
                <a class="nav-link" th:href="@{/rendezvous/new}">üìÖ Prendre RDV</a>
                <a class="nav-link" th:href="@{/dashboard/edit}">‚úèÔ∏è Modifier profil</a>
                <form th:action="@{/logout}" method="post" class="d-inline">
                    <button type="submit" class="btn btn-link nav-link p-0 border-0">üö™ D√©connexion</button>
                </form>
            </div>
        </nav>

        <!-- Messages -->
        <div th:if="${param.success}" class="alert alert-success alert-dismissible fade show">
            ‚úÖ <span th:text="${param.success}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show">
            ‚ùå <span th:text="${param.error}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- En-t√™te -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="stat-card card text-center py-3">
                    <div class="card-body">
                        <h1 class="display-6">üë§ Mon Tableau de Bord</h1>
                        <p class="lead mb-0">Bienvenue, <span th:text="${user.patient.nom + ' ' + user.patient.prenom}"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informations et statistiques -->
        <div class="row mb-4">
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">üìã Mes Informations</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Nom :</strong> <span th:text="${user.patient.nom}">-</span></p>
                        <p><strong>Pr√©nom :</strong> <span th:text="${user.patient.prenom}">-</span></p>
                        <p><strong>Email :</strong> <span th:text="${user.username}">-</span></p>
                        <p><strong>T√©l√©phone :</strong> 
                            <span th:if="${user.patient.telephone}" th:text="${user.patient.telephone}"></span>
                            <span th:unless="${user.patient.telephone}" class="text-muted">Non renseign√©</span>
                        </p>
                        <div class="mt-3">
                            <a th:href="@{/dashboard/edit}" class="btn btn-outline-primary btn-sm">‚úèÔ∏è Modifier mon profil</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">üìä Mes Statistiques</h5>
                    </div>
                    <div class="card-body text-center">
                        <!-- üî• COMPTE SEULEMENT LES RDV NON ANNULEÃÅS -->
                        <h2 class="display-4 text-success" th:text="${#lists.size(rendezvous.?[statut.name() != 'ANNULE'])}">0</h2>
                        <p class="lead">Rendez-vous √† venir</p>
                        <a th:href="@{/rendezvous/new}" class="btn btn-success btn-lg">üìÖ Prendre un RDV</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mes rendez-vous -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">üìÖ Mes Rendez-vous Actifs</h5>
            </div>
            <div class="card-body">
                <!-- üî• FILTRER POUR NE MONTRER QUE LES RDV NON ANNULEÃÅS -->
                <div th:if="${#lists.isEmpty(rendezvous.?[statut.name() != 'ANNULE'])}" class="alert alert-info text-center">
                    <h5>üì≠ Aucun rendez-vous programm√©</h5>
                    <p>Vous n'avez pas encore de rendez-vous de planifi√©.</p>
                    <a th:href="@{/rendezvous/new}" class="btn btn-primary">Prendre mon premier rendez-vous</a>
                </div>

                <div th:unless="${#lists.isEmpty(rendezvous.?[statut.name() != 'ANNULE'])}" class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>üë®‚Äç‚öïÔ∏è M√©decin</th>
                                <th>üìÖ Date et Heure</th>
                                <th>üìù Motif</th>
                                <th>üè∑Ô∏è Statut</th>
                                <th>‚ö° Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- üî• AFFICHER SEULEMENT LES RDV NON ANNULEÃÅS -->
                            <tr th:each="rdv : ${rendezvous}" 
                                th:if="${rdv.statut.name() != 'ANNULE'}">
                                <td>
                                    <strong th:text="${rdv.medecin.nom + ' ' + rdv.medecin.prenom}"></strong>
                                    <br>
                                    <small class="text-muted" th:text="${rdv.medecin.specialite}"></small>
                                </td>
                                <td th:text="${#temporals.format(rdv.dateHeure, 'dd/MM/yyyy √† HH:mm')}"></td>
                                <td>
                                    <span th:if="${rdv.motif}" th:text="${rdv.motif}"></span>
                                    <span th:unless="${rdv.motif}" class="text-muted">Non sp√©cifi√©</span>
                                </td>
                                <td>
                                    <span th:if="${rdv.statut == 'CONFIRME'}" class="badge bg-success" th:text="${rdv.statut}">CONFIRME</span>
                                    <span th:if="${rdv.statut == 'ANNULE'}" class="badge bg-danger" th:text="${rdv.statut}">ANNULE</span>
                                    <span th:if="${rdv.statut == 'EN_ATTENTE'}" class="badge bg-warning" th:text="${rdv.statut}">EN_ATTENTE</span>
                                </td>
                                <td>
                                    <!-- Bouton Annuler pour le patient -->
                                    <form th:action="@{/rendezvous/{id}/cancel(id=${rdv.id})}" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-danger btn-sm"
                                                th:disabled="${rdv.statut == 'ANNULE' || rdv.statut == 'CONFIRME'}"
                                                title="Annuler ce rendez-vous"
                                                onclick="return confirm('√ätes-vous s√ªr de vouloir annuler ce rendez-vous ?')">
                                            ‚ùå Annuler
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Section RDV annul√©s (optionnel) -->
        <div th:if="${not #lists.isEmpty(rendezvous.?[statut.name() == 'ANNULE'])}" class="card mt-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">üìã Historique des RDV annul√©s</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>M√©decin</th>
                                <th>Date pr√©vue</th>
                                <th>Motif</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="rdv : ${rendezvous}" th:if="${rdv.statut.name() == 'ANNULE'}">
                                <td>
                                    <span th:text="${rdv.medecin.nom + ' ' + rdv.medecin.prenom}"></span>
                                    <br>
                                    <small class="text-muted" th:text="${rdv.medecin.specialite}"></small>
                                </td>
                                <td th:text="${#temporals.format(rdv.dateHeure, 'dd/MM/yyyy HH:mm')}"></td>
                                <td>
                                    <span th:if="${rdv.motif}" th:text="${rdv.motif}"></span>
                                    <span th:unless="${rdv.motif}" class="text-muted">Non sp√©cifi√©</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- üî• SCRIPT POUR FORCER LE RAFRA√éCHISSEMENT -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Rafra√Æchir la page apr√®s une annulation r√©ussie
            const successMessage = document.querySelector('.alert-success');
            if (successMessage && successMessage.textContent.includes('annul√©')) {
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);
            }
        });
    </script>
</body>
</html>